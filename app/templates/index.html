<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†œä½œç‰©çŸ¥è¯†å›¾è°±ç³»ç»Ÿ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            height: 100vh;
        }
        
        .container {
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-size: 14px;
        }
        
        .user-info .username {
            font-weight: bold;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .controls button:hover {
            background: #0056b3;
        }
        
        #graph-container {
            width: 100%;
            height: 600px;
            position: relative;
            flex: 1;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡ºå¯¼è‡´æ»šåŠ¨æ¡å˜åŒ– */
        }
        
        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 3px;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
        
        .node-label {
            font-size: 14px;
            font-family: Arial, sans-serif;
            text-anchor: middle;
            pointer-events: none;
            font-weight: bold;
        }
        
        .tooltip {
            position: fixed; /* æ”¹ä¸ºfixedå®šä½ï¼Œé¿å…å½±å“æ–‡æ¡£æµ */
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            max-width: 350px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0; /* ä½¿ç”¨opacityè€Œä¸æ˜¯displayæ¥æ§åˆ¶æ˜¾ç¤º */
            transition: opacity 0.2s ease; /* æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
        }
        
        .tooltip.visible { 
            opacity: 1;
        }
        
        .sidebar {
            width: 25%; 
            background: white;
            border-right: 1px solid #dee2e6;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .sidebar-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        
        .search-section {
            margin-bottom: 30px;
        }
        
        .search-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
        }
        
        .search-btn:hover {
            background: #0056b3;
        }
        
        .main-content {
            flex: 1; 
            display: flex;
            flex-direction: column;
        }
        
        .qa-section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .qa-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
            resize: vertical;
            min-height: 60px;
        }
        
        .qa-answer {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .qa-loading {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>æŸ¥è¯¢é¢æ¿</h2>
        </div>
        <div class="sidebar-content">
            <div class="search-section">
                <h3>ğŸ” å±æ€§æœç´¢</h3>
                <div class="form-group">
                    <label for="entity-type">å®ä½“ç±»å‹:</label>
                    <select id="entity-type" onchange="updatePropertyOptions()">
                        <option value="Wheat">Wheat (å°éº¦)</option>
                        <option value="Region">Region (åœ°åŒº)</option>
                        <option value="Disease">Disease (ç—…å®³)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="property-key">å±æ€§å:</label>
                    <select id="property-key">
                        <option value="å“ç§åç§°">å“ç§åç§°</option>
                        <option value="åº“ç¼–å·">åº“ç¼–å·</option>
                        <option value="ç»Ÿä¸€ç¼–å·">ç»Ÿä¸€ç¼–å·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="property-value">å±æ€§å€¼:</label>
                    <input type="text" id="property-value" placeholder="è¾“å…¥æœç´¢å†…å®¹...">
                </div>
                <div class="form-group">
                    <label for="search-limit">ç»“æœæ•°é‡:</label>
                    <select id="search-limit">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button class="search-btn" onclick="searchByProperty()">æœç´¢å®ä½“</button>
            </div>
            
            <div class="search-section qa-section">
                <h3>ğŸ¤– æ™ºèƒ½é—®ç­”</h3>
                <div class="form-group">
                    <label for="question-input">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜:</label>
                    <textarea id="question-input" class="qa-input" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ç™½ä¼šå—åˆ°å“ªäº›ç—…å®³å½±å“ï¼Ÿ" style="width: 300px;"></textarea>
                </div>
                <button class="search-btn" onclick="askQuestion()">æé—®</button>
                <div id="qa-answer" class="qa-answer" style="display: none;"></div>
            </div>
            
            <div class="search-section">
                <h3>ğŸ“Š å›¾è°±ä¿¡æ¯</h3>
                <div id="graph-stats">
                    <p>èŠ‚ç‚¹æ•°: <span id="node-count">0</span></p>
                    <p>å…³ç³»æ•°: <span id="link-count">0</span></p>
                </div>
            </div>
            
            <div class="search-section">
                <h3>ğŸ¨ æ˜¾ç¤ºè®¾ç½®</h3>
                <button class="search-btn" onclick="refreshGraph()">åˆ·æ–°å›¾è°±</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1>å†œä½œç‰©çŸ¥è¯†å›¾è°±ç³»ç»Ÿ</h1>
                <div class="user-info">
                    <span>æ¬¢è¿ï¼Œ</span>
                    <span class="username" id="current-username">åŠ è½½ä¸­...</span>
                    <a href="/admin" id="admin-link" style="display: none; color: white; text-decoration: none; margin-right: 10px; padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 12px;">ç®¡ç†</a>
                    <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>
            
            <div class="controls">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label for="view-selector" style="font-weight: bold; color: #333;">é€‰æ‹©è§†å›¾:</label>
                        <select id="view-selector" onchange="changeView()" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="overview">å›¾è°±æ¦‚è§ˆ</option>
                            <option value="wheat-region">å°éº¦-åœ°åŒº</option>
                            <option value="wheat-disease">å°éº¦-ç—…å®³</option>
                        </select>
                    </div>
                    <span id="view-description" style="color: #666; font-size: 14px;">æ˜¾ç¤º: AFFECTED_BY å’Œ GROWS_IN å…³ç³»</span>
                </div>
            </div>
            
            <div id="graph-container">
                <div class="loading" id="loading">æ­£åœ¨åŠ è½½å›¾è°±æ•°æ®...</div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <!-- æ–°å¢è¯¦ç»†ä¿¡æ¯æ¨¡æ€çª—å£ -->
    <div id="detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 500px; max-height: 70vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="modal-title">è¯¦ç»†ä¿¡æ¯</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        let svg, simulation, nodes, links;
        let graphData = { nodes: [], relationships: [] };
        let currentNodeDisplay = 'name';
        
        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                console.log('ç³»ç»Ÿå¥åº·çŠ¶æ€:', health);
                return health.status === 'healthy';
            } catch (error) {
                console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                return false;
            }
        }
        
        // åˆå§‹åŒ–SVG
        function initSVG() {
            const container = d3.select("#graph-container");
            const width = container.node().getBoundingClientRect().width;
            const height = container.node().getBoundingClientRect().height;
            
            // æ¸…é™¤ç°æœ‰çš„SVG
            container.select("svg").remove();
            
            svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => {
                    svg.select("g").attr("transform", event.transform);
                });
            
            svg.call(zoom);
            
            // åˆ›å»ºä¸»è¦çš„gå…ƒç´ 
            const g = svg.append("g");
            
            return { width, height, g };
        }
        
        function getNodeColor(labels) {
            const colors = {
                'Wheat': '#f39c12',
                'Region': '#27ae60',
                'Disease': '#e74c3c',
                'Person': '#3498db',
                'Company': '#9b59b6',
                'default': '#95a5a6'
            };
            
            if (labels && labels.length > 0) {
                return colors[labels[0]] || colors.default;
            }
            return colors.default;
        }
        
        function getNodeLabel(node) {
            const props = node.properties;
            const labels = node.labels || [];
            
            if (labels.includes('Wheat')) {
                return props['å“ç§åç§°'] || props.name || `Wheat ${node.id}`;
            } else if (labels.includes('Region')) {
                return props['åŸäº§åœ°'] || props.name || `Region ${node.id}`;
            } else if (labels.includes('Disease')) {
                return props['ç—…å®³åç§°'] || props.name || `Disease ${node.id}`;
            }
            
            // é»˜è®¤æ˜¾ç¤ºé€»è¾‘
            const displayProp = currentNodeDisplay;
            if (displayProp === 'id') {
                return `${node.id}`;
            }
            
            return props[displayProp] || props.name || props.title || props.label || `Node ${node.id}`;
        }
        
        // åˆ›å»ºå·¥å…·æç¤ºå†…å®¹
        function createTooltipContent(node) {
            let content = `<h4>${getNodeLabel(node)}</h4>`;
            content += `<div class="property"><strong>ID:</strong> ${node.id}</div>`;
            
            if (node.labels && node.labels.length > 0) {
                content += `<div class="property"><strong>æ ‡ç­¾:</strong> ${node.labels.join(', ')}</div>`;
            }
            
            if (node.properties && Object.keys(node.properties).length > 0) {
                content += `<div class="property"><strong>å±æ€§:</strong></div>`;
                for (const [key, value] of Object.entries(node.properties)) {
                    content += `<div class="property">&nbsp;&nbsp;${key}: ${value}</div>`;
                }
            }
            
            return content;
        }
        
        function createLinkTooltipContent(link) {
            let content = `<h4>å…³ç³»: ${link.type}</h4>`;
            content += `<div class="property"><strong>æºèŠ‚ç‚¹:</strong> ${link.source.id}</div>`;
            content += `<div class="property"><strong>ç›®æ ‡èŠ‚ç‚¹:</strong> ${link.target.id}</div>`;
            
            if (link.properties && Object.keys(link.properties).length > 0) {
                content += `<div class="property"><strong>å…³ç³»å±æ€§:</strong></div>`;
                for (const [key, value] of Object.entries(link.properties)) {
                    content += `<div class="property">&nbsp;&nbsp;${key}: ${value}</div>`;
                }
            }
            
            return content;
        }
        
        function createDetailModalContent(data, type) {
            let content = '';
            
            if (type === 'node') {
                content += `<div class="detail-section">`;
                content += `<h4>èŠ‚ç‚¹ä¿¡æ¯</h4>`;
                content += `<p><strong>ID:</strong> ${data.id}</p>`;
                
                if (data.labels && data.labels.length > 0) {
                    content += `<p><strong>æ ‡ç­¾:</strong> ${data.labels.join(', ')}</p>`;
                }
                
                if (data.properties && Object.keys(data.properties).length > 0) {
                    content += `<h5>å±æ€§åˆ—è¡¨:</h5>`;
                    content += `<table style="width: 100%; border-collapse: collapse;">`;
                    for (const [key, value] of Object.entries(data.properties)) {
                        content += `<tr style="border-bottom: 1px solid #eee;">`;
                        content += `<td style="padding: 8px; font-weight: bold;">${key}</td>`;
                        content += `<td style="padding: 8px;">${value}</td>`;
                        content += `</tr>`;
                    }
                    content += `</table>`;
                }
                content += `</div>`;
            } else if (type === 'link') {
                content += `<div class="detail-section">`;
                content += `<h4>å…³ç³»ä¿¡æ¯</h4>`;
                content += `<p><strong>ç±»å‹:</strong> ${data.type}</p>`;
                content += `<p><strong>æºèŠ‚ç‚¹:</strong> ${getNodeLabel(data.source)} (ID: ${data.source.id})</p>`;
                content += `<p><strong>ç›®æ ‡èŠ‚ç‚¹:</strong> ${getNodeLabel(data.target)} (ID: ${data.target.id})</p>`;
                
                if (data.properties && Object.keys(data.properties).length > 0) {
                    content += `<h5>å…³ç³»å±æ€§:</h5>`;
                    content += `<table style="width: 100%; border-collapse: collapse;">`;
                    for (const [key, value] of Object.entries(data.properties)) {
                        content += `<tr style="border-bottom: 1px solid #eee;">`;
                        content += `<td style="padding: 8px; font-weight: bold;">${key}</td>`;
                        content += `<td style="padding: 8px;">${value}</td>`;
                        content += `</tr>`;
                    }
                    content += `</table>`;
                } else {
                    content += `<p><em>è¯¥å…³ç³»æ²¡æœ‰é¢å¤–å±æ€§</em></p>`;
                }
                content += `</div>`;
            }
            
            return content;
        }
        
        function showDetailModal(data, type) {
            const modal = document.getElementById('detail-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            if (type === 'node') {
                title.textContent = `èŠ‚ç‚¹è¯¦æƒ…: ${getNodeLabel(data)}`;
            } else {
                title.textContent = `å…³ç³»è¯¦æƒ…: ${data.type}`;
            }
            
            content.innerHTML = createDetailModalContent(data, type);
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        // æ¸²æŸ“å›¾è°±
        function renderGraph() {
            const { width, height, g } = initSVG();
            
            // è½¬æ¢æ•°æ®æ ¼å¼
            nodes = graphData.nodes.map(d => ({ ...d }));
            links = graphData.relationships.map(d => ({
                source: d.source,
                target: d.target,
                type: d.type,
                properties: d.properties
            }));
            
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(120))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(40));
            
            // ç»˜åˆ¶è¿çº¿
            const link = g.append("g")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("class", "link")
                .style("cursor", "pointer")
                .on("mouseover", function(event, d) {
                    const rect = this.getBoundingClientRect();
                    const tooltip = d3.select("#tooltip");
                    tooltip
                        .classed("visible", true)
                        .html(createLinkTooltipContent(d))
                        .style("left", (rect.left + rect.width/2 + 10) + "px")
                        .style("top", (rect.top - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").classed("visible", false);
                })
                .on("click", function(event, d) {
                    event.stopPropagation();
                    showDetailModal(d, 'link');
                });
            
            const node = g.append("g")
                .selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", 25)
                .attr("fill", d => getNodeColor(d.labels))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            const label = g.append("g")
                .selectAll("text")
                .data(nodes)
                .enter().append("text")
                .attr("class", "node-label")
                .text(d => getNodeLabel(d))
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .style("fill", "white")
                .style("font-weight", "bold")
                .style("font-size", "12px")
                .style("pointer-events", "none");
            
            // æ·»åŠ é¼ æ ‡äº‹ä»¶
            const tooltip = d3.select("#tooltip");
            
            node
                .on("mouseover", function(event, d) {
                    const rect = this.getBoundingClientRect();
                    tooltip
                        .classed("visible", true)
                        .html(createTooltipContent(d))
                        .style("left", (rect.left + rect.width + 10) + "px")
                        .style("top", (rect.top - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.classed("visible", false);
                })
                .on("click", function(event, d) {
                    event.stopPropagation();
                    showDetailModal(d, 'node');
                });
            
            // æ›´æ–°ä½ç½®
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
                
                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });
            
            document.getElementById("node-count").textContent = nodes.length;
            document.getElementById("link-count").textContent = links.length;
        }
        
        async function searchByProperty() {
            try {
                const entityType = document.getElementById('entity-type').value;
                const propertyKey = document.getElementById('property-key').value;
                const propertyValue = document.getElementById('property-value').value.trim();
                const limit = parseInt(document.getElementById('search-limit').value);
                
                if (!propertyValue) {
                    alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
                    return;
                }
                
                document.getElementById("loading").style.display = "block";
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        entity_type: entityType,
                        property_key: propertyKey,
                        property_value: propertyValue,
                        limit: limit
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`æœç´¢å¤±è´¥: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                graphData = result;
                document.getElementById("loading").style.display = "none";
                renderGraph();
                
                console.log(`ğŸ” æœç´¢å®Œæˆ: æ‰¾åˆ° ${result.nodes.length} ä¸ªèŠ‚ç‚¹`);
                
            } catch (error) {
                document.getElementById("loading").innerHTML = 
                    `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
                console.error('âŒ æœç´¢é”™è¯¯:', error);
            }
        }
        
        const entityProperties = {
            'Wheat': ['å“ç§åç§°', 'åº“ç¼–å·', 'ç»Ÿä¸€ç¼–å·'],
            'Region': ['åŸäº§åœ°', 'çœ', 'ç§ç±»'],
            'Disease': ['ç—…å®³åç§°']
        };
        
        function updatePropertyOptions() {
            const entityType = document.getElementById('entity-type').value;
            const propertySelect = document.getElementById('property-key');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            propertySelect.innerHTML = '';
            
            if (entityType && entityProperties[entityType]) {
                // æ·»åŠ ç‰¹å®šå®ä½“çš„å±æ€§
                entityProperties[entityType].forEach(prop => {
                    const option = document.createElement('option');
                    option.value = prop;
                    option.textContent = prop;
                    propertySelect.appendChild(option);
                });
            }
        }
        
        // æ‹–æ‹½äº‹ä»¶å¤„ç†
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // åŠ è½½å›¾è°±æ•°æ®
        async function loadGraphData() {
            try {
                document.getElementById("loading").style.display = "block";
                
                console.log('ğŸ”„ å¼€å§‹åŠ è½½å›¾è°±æ•°æ®...');
                
                let response = await fetch('/api/graph-data');
                response = await handleApiResponse(response);
                if (!response) return;
                
                console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                graphData = await response.json();
                console.log('ğŸ“Š æ¥æ”¶åˆ°æ•°æ®:', graphData);
                
                if (graphData.error) {
                    throw new Error(graphData.error);
                }
                
                if (!graphData.nodes || graphData.nodes.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°AFFECTED_BYæˆ–GROWS_INå…³ç³»æ•°æ®');
                }
                
                document.getElementById("loading").style.display = "none";
                renderGraph();
                console.log('âœ… å›¾è°±æ¸²æŸ“å®Œæˆ');
                
            } catch (error) {
                const errorMsg = `åŠ è½½å¤±è´¥: ${error.message}`;
                document.getElementById("loading").innerHTML = 
                    `<div class="error">${errorMsg}</div>`;
                console.error('âŒ å›¾è°±åŠ è½½é”™è¯¯:', error);
            }
        }
        
        // åˆ·æ–°å›¾è°±
        function refreshGraph() {
            loadGraphData();
        }
        
        async function askQuestion() {
            try {
                const question = document.getElementById('question-input').value.trim();
                const answerDiv = document.getElementById('qa-answer');
                
                if (!question) {
                    alert('è¯·è¾“å…¥é—®é¢˜');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                answerDiv.style.display = 'block';
                answerDiv.innerHTML = '<div class="qa-loading">æ­£åœ¨æ€è€ƒä¸­...</div>';
                
                const response = await fetch('/api/question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // æ˜¾ç¤ºå›ç­”
                answerDiv.innerHTML = `
                    <div><strong>é—®é¢˜:</strong> ${result.question}</div>
                    <div style="margin-top: 10px;"><strong>å›ç­”:</strong></div>
                    <div style="margin-top: 5px; padding: 8px; background: #e3f2fd; border-radius: 4px;">${result.answer}</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        <details>
                            <summary>æŸ¥çœ‹æŠ€æœ¯è¯¦æƒ…</summary>
                            <div style="margin-top: 5px;"><strong>CypheræŸ¥è¯¢:</strong> <code>${result.cypher}</code></div>
                            <div style="margin-top: 5px;"><strong>æŸ¥è¯¢ç»“æœ:</strong> ${result.result.length} æ¡è®°å½•</div>
                        </details>
                    </div>
                `;
                
                console.log('ğŸ¤– é—®ç­”å®Œæˆ:', result);
                
            } catch (error) {
                document.getElementById('qa-answer').innerHTML = 
                    `<div style="color: #dc3545;">é—®ç­”å¤±è´¥: ${error.message}</div>`;
                console.error('âŒ é—®ç­”é”™è¯¯:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('ğŸŒ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            loadUserInfo().then(() => {
                loadGraphData();
            });
        });
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“
        window.addEventListener('resize', () => {
            if (graphData.nodes.length > 0) {
                renderGraph();
            }
        });
        
        // æ–°å¢å›è½¦é”®æœç´¢æ”¯æŒ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('property-value').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchByProperty();
                }
            });
            
            document.getElementById('question-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    askQuestion();
                }
            });
        });
        
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('detail-modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        async function changeView() {
            try {
                const viewType = document.getElementById('view-selector').value;
                const descriptionSpan = document.getElementById('view-description');
                
                // æ›´æ–°æè¿°æ–‡æœ¬
                const descriptions = {
                    'overview': 'æ˜¾ç¤º: AFFECTED_BY å’Œ GROWS_IN å…³ç³»',
                    'wheat-region': 'æ˜¾ç¤º: å°éº¦ä¸åœ°åŒºçš„ GROWS_IN å…³ç³»',
                    'wheat-disease': 'æ˜¾ç¤º: å°éº¦ä¸ç—…å®³çš„ AFFECTED_BY å…³ç³»'
                };
                descriptionSpan.textContent = descriptions[viewType] || 'åŠ è½½ä¸­...';
                
                document.getElementById("loading").style.display = "block";
                
                console.log(`ğŸ”„ åˆ‡æ¢åˆ°è§†å›¾: ${viewType}`);
                
                let response;
                if (viewType === 'overview') {
                    response = await fetch('/api/graph-data');
                } else {
                    response = await fetch(`/api/view/${viewType}`);
                }
                
                console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                graphData = await response.json();
                console.log('ğŸ“Š æ¥æ”¶åˆ°æ•°æ®:', graphData);
                
                if (graphData.error) {
                    throw new Error(graphData.error);
                }
                
                if (!graphData.nodes || graphData.nodes.length === 0) {
                    throw new Error(`æ²¡æœ‰æ‰¾åˆ°${viewType}è§†å›¾çš„æ•°æ®`);
                }
                
                document.getElementById("loading").style.display = "none";
                renderGraph();
                console.log(`âœ… ${viewType}è§†å›¾æ¸²æŸ“å®Œæˆ`);
                
            } catch (error) {
                const errorMsg = `è§†å›¾åˆ‡æ¢å¤±è´¥: ${error.message}`;
                document.getElementById("loading").innerHTML = 
                    `<div class="error">${errorMsg}</div>`;
                console.error('âŒ è§†å›¾åˆ‡æ¢é”™è¯¯:', error);
            }
        }
        
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                if (response.ok) {
                    const userInfo = await response.json();
                    document.getElementById('current-username').textContent = userInfo.username;
                    
                    if (userInfo.username === 'admin') {
                        document.getElementById('admin-link').style.display = 'inline-block';
                    }
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                window.location.href = '/login';
            }
        }
        
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('ç™»å‡ºå¤±è´¥');
                }
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
                alert('ç™»å‡ºå¤±è´¥');
            }
        }
        
        async function handleApiResponse(response) {
            if (response.status === 401) {
                const data = await response.json();
                if (data.redirect) {
                    window.location.href = data.redirect;
                    return null;
                }
            }
            return response;
        }
    </script>
</body>
</html>
